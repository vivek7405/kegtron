(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{Hijf:function(){},XETS:function(t){t.exports={keg:"keg__TxwXi"}},hul5:function(t,e,s){"use strict";s.r(e);var a=s("hosL"),i=(s("Y3FI"),s("XETS"),s("jmCe")),r=s("IMbM"),l=(s("Hijf"),s("TiKg")),h=s.n(l);s("czhI");class n extends a.Component{constructor(t){super(t),this.ref=t=>{var e=this;setTimeout(()=>{t&&t.clientWidth&&0!=t.clientWidth&&e.setState({width:t.clientWidth})},1)},this.getRows=()=>this.props.data.reverse().map((function(t){return{x:t.timestamp,y:t.level,vol:t.vol}})),this.getMaxX=t=>{var e=Math.max.apply(null,t.map((function(t){return t.x})));return e>0&&(e=h()(e).add(1,"hour").startOf("hour")),e},this.getMaxY=t=>Math.max.apply(null,t.map((function(t){return t.y||0}))),this.getMinX=t=>{var e=Math.min.apply(null,t.map((function(t){return t.x})));return e>0&&(e=h()(e).startOf("hour")),e},this.getGridLabelsPointsArr=(t,e,s,i,r,l,n,o,c,d)=>{for(var u=this,p=[],b=[],m=0;m<=l;m++){var v=m*(o-c-d)/l;p.push(["M",0,v+d].join(" ")),p.push(["L",n,v+d].join(" ")),0!=t.length&&(m<l&&b.push(Object(a.h)("text",{x:2,y:v+d+9,class:"label"},(l-m)*r/l)))}for(var j=0;j<i;j++){var f=j*n/i;if(p.push(["M",f,0].join(" ")),p.push(["L",f,o-c].join(" ")),0!=t.length){var g=h()(e+(s-e)*j/i);b.push(Object(a.h)("text",{x:f+2,y:o-12,class:"label"},g.format("YYYY-DD-MM"))),b.push(Object(a.h)("text",{x:f+2,y:o-2,class:"label"},g.format("hh:mm:ss")))}}return[p,b,t.map((function(t){return["L",u.mkx(t.x,n,s,e),u.mky(t.y,o,r,c,d)].join(" ")}))]},this.mkx=function(t,e,s,a){return parseInt(e*(t-a)/(s-a)||0)},this.mky=function(t,e,s,a,i){return parseInt((e-a-i)*(1-t/(s||1))||0)+i},this.getServings=(t,e,s,a,i)=>{var r=this,l=Math.max.apply(null,t.map((function(t){return t.vol||0})));return t.map((function(t){var h=r.mkx(t.x,a,e,s),n=(i*(t.vol||1)/(l||1)).toFixed(0);return["M",h,i,"L",h,i-n].join(" ")}))},this.state={width:400}}render(){var t=280,e=5,s=this.state.width,i=this.getRows(),r=this.getMaxX(i),l=this.getMinX(i);if(h.a.duration(r-l).asHours()<2)e=6;else for(;h.a.duration(r-l).asHours()%e>0;)l=l.add(-1,"hour");var n=this.getGridLabelsPointsArr(i,l,r,e,100,5,s,t,25,120),o=n[0],c=n[1],d=n[2],u=i[0]?["M",this.mkx(i[0].x,s,r,l),this.mky(i[0].y,t,100,25,120)].join(" "):"M 0 0",p=this.getServings(i,r,l,s,120);return Object(a.h)("div",{class:"w-100",style:"height: 280px",ref:this.ref},Object(a.h)("svg",{fill:"none",class:"h-100 w-100"},Object(a.h)("style",{},".label {fill: #777; font: italic 10px sans-serif;}.title {fill: #555; font: bold 14px sans-serif;}"),c,Object(a.h)("path",{d:"M 0 120 L 0 0 L "+s+" 0",stroke:"#ccc"}),Object(a.h)("rect",{x:"0",y:120,width:s,height:135,fill:"#fafafa"}),Object(a.h)("text",{x:"30",y:"20",stroke:"#aaa"},"Serving History"),Object(a.h)("text",{x:"30",y:140,stroke:"#aaa"},"Volume History"),Object(a.h)("path",{d:p.join(" "),stroke:"blue","stroke-width":"7"}),Object(a.h)("path",{d:o.join(" "),stroke:"#ccc","stroke-width":"0.5"}),Object(a.h)("path",{d:u+d.join(" "),stroke:"#3cc","stroke-width":"2"})))}}s.d(e,"default",(function(){return c}));var o=s("czhI").default;class c extends a.Component{constructor(t){super(t),this.componentDidMount=()=>{this.props.app.state.devices&&0===Object.keys(this.props.app.state.devices).length&&this.props.app.state.devices.constructor===Object&&r.a.getDevices(this.props.app),this.props.app.setState({headerName:"Sites / "+this.props.name+" / "+this.props.id+" / "+(+this.props.port+1),backlink:"/sites/"+this.props.name}),this.setState({end:"now",start:h()().add(-5,"days").format("YYYY-MM-DD HH:MM")})},this.componentWillReceiveProps=t=>{var e=this,s=e.getDevicePubkeyById(t.app,t.id);if(s){if(!e.ws){var a=i.a.mdashURL.replace(/^http/,"ws")+"/api/v2/m/device/notify?access_token="+s;e.ws=e.websocket(a),e.ws.onmessage=function(){r.a.getDevices(e.props.app)}}e.setState({pubkey:s,d:t.app.state.devices[s],data:[]}),e.getServingHistory(s)}},this.componentWillUnmount=()=>{this.ws&&this.ws.close()},this.getDevicePubkeyById=(t,e)=>{for(var s in t.state.devices){if(t.state.devices[s].id==e)return s}return null},this.getServingHistory=t=>{var e=this;return o.get(i.a.mdashURL+"/api/v2/m/device/data/servings?access_token="+t).then((function(t){for(var s=[],a=0;a<t.data.rows.length;a++){var i=JSON.parse(t.data.rows[a][3]);i.port==e.props.port&&(i.timestamp=h.a.utc(t.data.rows[a][0]).local(),s.push(i))}e.setState({data:s})}))},this.websocket=t=>{var e={shouldReconnect:!0,close:function(){e.shouldReconnect=!1,e.ws.close()}};return function s(){var a,i=new WebSocket(t);i.onmessage=function(t){try{a=JSON.parse(t.data)}catch(e){console.log("Invalid ws frame:",t.data)}a&&e.onmessage(a)},i.onclose=function(){window.clearTimeout(e.tid),e.shouldReconnect&&(e.tid=window.setTimeout(s,1e3))},e.ws=i}(),e},this.mlToUnits=(t,e)=>e.displayUnits?+t+" mL":(.033814*+t).toFixed(1)+" oz",this.mlToUnits2=(t,e)=>e.displayUnits?(t/1e3).toFixed(2)+" L":(t/3785.41).toFixed(2)+" gal",this.getFilteredData=()=>{var t=h()(this.state.start,"YYYY-MM-DDThh:mm"),e="now"==this.state.end?h()().local():this.state.end;return(this.state.data||[]).filter(s=>s.timestamp.isAfter(h()(t))&&s.timestamp.isBefore(h()(e)))},this.getEventsTable=(t,e)=>{var s=this,i=e.config||{};return Object(a.h)("div",{class:"table-responsive",style:"max-height: 15em"},Object(a.h)("table",{class:"table table-sm table-borderless small text-nowrap"},Object(a.h)("tr",null,Object(a.h)("th",null,"Timestamp"),Object(a.h)("th",null,"Serving Size"),Object(a.h)("th",null,"Level")),t.map((function(t){return Object(a.h)("tr",{},Object(a.h)("td",null,t.timestamp.format("YYYY-MM-DD HH:mm")),Object(a.h)("td",null,s.mlToUnits(t.vol,i)),Object(a.h)("td",null,(t.level||0).toFixed(1),"%"))}))))},this.getInfoTable=(t,e,s)=>{var i=e.config||{},r=i.displayUnits,l=r?i.temp.toFixed(1):(9*i.temp/5+32).toFixed(1),n=r?"℃":"℉";return Object(a.h)("div",{class:"table-responsive"},Object(a.h)("table",{class:"table table-sm table-borderless small"},Object(a.h)("tr",null,Object(a.h)("td",null,"Description"),Object(a.h)("th",{class:"text-right"},t.userDesc)),Object(a.h)("tr",null,Object(a.h)("td",null,"Status"),Object(a.h)("th",{class:"text-right "+(e.online?"text-success":"text-danger")},e.online?"online":"offline")),Object(a.h)("tr",null,Object(a.h)("td",null,"Temperature"),Object(a.h)("th",{class:"text-right"},l,n)),Object(a.h)("tr",null,Object(a.h)("td",null,"Humidity"),Object(a.h)("th",{class:"text-right"},(1*i.humidity).toFixed(1),"%")),Object(a.h)("tr",null,Object(a.h)("td",null,"Model"),Object(a.h)("th",{class:"text-right"},i.modelNum)),Object(a.h)("tr",null,Object(a.h)("td",null,"Port"),Object(a.h)("th",{class:"text-right"},parseInt(this.props.port)+1)),Object(a.h)("tr",null,Object(a.h)("td",null,"Keg Size"),Object(a.h)("th",{class:"text-right"},this.mlToUnits2(t.volSize,i))),Object(a.h)("tr",null,Object(a.h)("td",null,"Starting Volume"),Object(a.h)("th",{class:"text-right"},this.mlToUnits2(t.volStart,i))),Object(a.h)("tr",null,Object(a.h)("td",null,"Last Cleaned"),Object(a.h)("th",{class:"text-right"},t.dateCleaned?h()(t.dateCleaned).fromNow():"-")),Object(a.h)("tr",null,Object(a.h)("td",null,"Days on Tap"),Object(a.h)("th",{class:"text-right"},t.dateTapped?h()(t.dateTapped||void 0).fromNow().replace(" ago",""):"-")),Object(a.h)("tr",null,Object(a.h)("td",null,"Kegs Served"),Object(a.h)("th",{class:"text-right"},t.kegsServed||0)),Object(a.h)("tr",null,Object(a.h)("td",null,"Volume Served"),Object(a.h)("th",{class:"text-right"},this.mlToUnits2(t.volDisp,i))),Object(a.h)("tr",null,Object(a.h)("td",null,"Last Served"),Object(a.h)("th",{class:"text-right"},0==s.length?"-":this.mlToUnits(s[0].vol,i)))))},this.getInfoDiv=t=>{var e=120,s=240,i=t.volStart-t.volDisp||0;t.volSize&&(i/=t.volSize);var r=220*(i<0?0:i),l=parseInt((100*i).toFixed(0));return Object(a.h)("div",{class:"float-left mr-5",style:"margin: auto"},Object(a.h)("svg",{class:"mr-2 bg-light",width:e,height:s},Object(a.h)("rect",{fill:"#333",x:"0",y:"0",width:e,height:s,rx:12}),Object(a.h)("rect",{fill:"#79f",x:"10",y:s-r-10,width:100,height:r}),Object(a.h)("text",{textAnchor:"middle",x:l<10?"35%":100===l?"16%":"25%",y:120,fill:"#ff0",style:"font-weight: bold; font-size: 200%"},l,"%")))},this.getGraphToolBar=()=>{var t=this,e=String(t.state.start).includes("T")?t.state.start:h()(t.state.start).format("YYYY-MM-DDThh:mm"),s="now"==t.state.end?h()().format("YYYY-MM-DDThh:mm"):String(t.state.end).includes("T")?t.state.end:h()(t.state.end).format("YYYY-MM-DDThh:mm");return Object(a.h)("div",{class:"form-inline"},Object(a.h)("span",{class:"mr-5"},"Graph"),Object(a.h)("label",{class:"mr-2 small"},"Start:"),Object(a.h)("input",{class:"form-control form-control-sm",type:"datetime-local",value:e,onChange:function(e){t.setState({start:e.target.value})}}),Object(a.h)("label",{class:"mx-2 small"},"End:"),Object(a.h)("input",{class:"form-control form-control-sm",type:"datetime-local",value:s,onChange:function(e){t.setState({end:e.target.value})}}))},this.state={}}render(){var t=(((this.state.d||{}).shadow||{}).state||{}).reported||{},e=(t.config||{})["port"+this.props.port]||{},s=this.getFilteredData();return Object(a.h)("div",{class:"overflow-auto p-2"},Object(a.h)("div",{class:"font-weight-light card-deck"},Object(a.h)("div",{class:"card my-2"},Object(a.h)("div",{class:"card-header font-weight-bold"},"Port "+(+this.props.port+1)+": "+(e.userName||"")),Object(a.h)("div",{class:"card-body d-flex"},this.getInfoDiv(e),this.getInfoTable(e,t,s))),Object(a.h)("div",{class:"card my-2"},Object(a.h)("div",{class:"card-header font-weight-bold"},"Serving History"),Object(a.h)("div",{class:"card-body"},this.getEventsTable(s,t)))),Object(a.h)("div",{class:"font-weight-light card-deck"},Object(a.h)("div",{class:"card my-2"},Object(a.h)("div",{class:"card-header font-weight-bold"},this.getGraphToolBar()),Object(a.h)("div",{class:"card-body table-responsive"},Object(a.h)(n,{data:s})))))}}}}]);
//# sourceMappingURL=route-keg.chunk.d4398.esm.js.map